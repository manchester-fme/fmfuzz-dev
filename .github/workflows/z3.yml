name: Build Z3

on:
  workflow_dispatch:
    inputs:
      z3_commit_hash:
        description: 'Optional: Z3 commit hash to build (skips upstream check)'
        required: false
        type: string
  schedule:
    - cron: '0 * * * *'  # Run every hour

jobs:
  check-upstream:
    runs-on: ubuntu-latest
    outputs:
      build_needed: ${{ steps.set-outputs.outputs.build_needed }}
      sha: ${{ steps.set-outputs.outputs.sha }}
      is_manual_build: ${{ steps.set-outputs.outputs.is_manual_build }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Download last built SHA from artifacts
        if: inputs.z3_commit_hash == ''
        uses: dawidd6/action-download-artifact@v6
        id: download-sha
        continue-on-error: true
        with:
          name: z3-last-sha
          path: .cache
          github_token: ${{ secrets.GITHUB_TOKEN }}
          workflow: z3.yml
      
      - name: Check upstream or use provided commit
        id: set-outputs
        run: |
          if [ -n "${{ inputs.z3_commit_hash }}" ]; then
            echo "ðŸ”¨ Building provided commit hash: ${{ inputs.z3_commit_hash }}"
            echo "build_needed=true" >> $GITHUB_OUTPUT
            echo "sha=${{ inputs.z3_commit_hash }}" >> $GITHUB_OUTPUT
            echo "is_manual_build=true" >> $GITHUB_OUTPUT
          else
            echo "ðŸ“¥ Checking for upstream changes..."
            # Ensure .cache directory exists
            mkdir -p .cache
            ./scripts/check-upstream.sh z3 https://github.com/Z3Prover/z3.git
            echo "build_needed=$(cat .build_status | grep build_needed | cut -d'=' -f2)" >> $GITHUB_OUTPUT
            echo "sha=$(cat .build_status | grep sha | cut -d'=' -f2)" >> $GITHUB_OUTPUT
            echo "is_manual_build=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload last built SHA artifact (keep fresh when no build needed)
        if: inputs.z3_commit_hash == '' && steps.set-outputs.outputs.build_needed == 'false'
        run: |
          mkdir -p .cache
          if [ ! -f ".cache/z3_last_sha" ]; then
            echo "${{ steps.set-outputs.outputs.sha }}" > .cache/z3_last_sha
          fi
      
      - name: Upload last built SHA artifact
        if: inputs.z3_commit_hash == '' && steps.set-outputs.outputs.build_needed == 'false'
        uses: actions/upload-artifact@v4
        with:
          name: z3-last-sha
          path: .cache/z3_last_sha
          retention-days: 30
          if-no-files-found: ignore

  build-static:
    needs: check-upstream
    if: needs.check-upstream.outputs.build_needed == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Prepare Z3 for specific commit
        if: inputs.z3_commit_hash != ''
        run: |
          echo "ðŸ”¨ Building specific commit: ${{ inputs.z3_commit_hash }}"
          if [ -d "z3" ]; then
            rm -rf z3
          fi
          git clone https://github.com/Z3Prover/z3.git z3
          cd z3
          git checkout ${{ inputs.z3_commit_hash }}
          echo "Checked out commit: $(git rev-parse HEAD)"
          cd ..
      
      - name: Build Z3 static binary
        run: ./scripts/z3/build.sh --static
      
      - name: Get commit hash
        id: get-commit
        working-directory: z3
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "Z3 commit hash: $COMMIT_HASH"
      
      - name: Measure binary size
        working-directory: z3
        run: |
          if [ -f "./build/z3" ]; then
            BINARY_SIZE=$(du -h ./build/z3 | cut -f1)
            BINARY_SIZE_BYTES=$(stat -f%z ./build/z3 2>/dev/null || stat -c%s ./build/z3 2>/dev/null)
            echo "Binary size: $BINARY_SIZE ($BINARY_SIZE_BYTES bytes)"
            echo "binary_size=$BINARY_SIZE" >> $GITHUB_OUTPUT
            echo "binary_size_bytes=$BINARY_SIZE_BYTES" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Binary not found at ./build/z3"
            exit 1
          fi
      
      - name: Collect build artifacts (headers, binary, compile_commands)
        run: |
          ./scripts/z3/collect_build_artifacts.sh z3/build .artifacts
      
      - name: Compress collected artifacts
        run: |
          cd .artifacts
          tar -czf ../z3/build/artifacts.tar.gz .
          cd ..
          COMPRESSED_SIZE=$(du -h z3/build/artifacts.tar.gz | cut -f1)
          echo "Compressed size: $COMPRESSED_SIZE"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Upload production binary to S3
        run: |
          aws s3api put-object \
            --bucket ${{ secrets.AWS_S3_BUCKET }} \
            --key solvers/z3/builds/production/${{ steps.get-commit.outputs.commit_hash }}.tar.gz \
            --body z3/build/artifacts.tar.gz \
            --tagging "Type=Production"
          echo "âœ… Uploaded production binary to S3"
      
      - name: Update last built SHA artifact
        if: needs.check-upstream.outputs.is_manual_build != 'true'
        run: |
          mkdir -p .cache
          echo "${{ steps.get-commit.outputs.commit_hash }}" > .cache/z3_last_sha
      
      - name: Upload last built SHA artifact
        if: needs.check-upstream.outputs.is_manual_build != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: z3-last-sha
          path: .cache/z3_last_sha
          retention-days: 30
          overwrite: true

  build-static-coverage:
    needs: check-upstream
    if: needs.check-upstream.outputs.build_needed == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Install LLVM/Clang 17
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: '17'
      
      - name: Add LLVM to PATH
        run: echo "${{ env.LLVM_PATH }}/bin" >> $GITHUB_PATH
      
      - name: Clean any previous build
        run: |
          if [ -d "z3/build" ]; then
            rm -rf z3/build
            echo "Cleaned previous build directory"
          fi
      
      - name: Prepare Z3 for specific commit
        if: inputs.z3_commit_hash != ''
        run: |
          echo "ðŸ”¨ Building specific commit: ${{ inputs.z3_commit_hash }}"
          if [ -d "z3" ]; then
            rm -rf z3
          fi
          git clone https://github.com/Z3Prover/z3.git z3
          cd z3
          git checkout ${{ inputs.z3_commit_hash }}
          echo "Checked out commit: $(git rev-parse HEAD)"
          cd ..
      
      - name: Build Z3 static binary with coverage
        run: |
          # Use clang with GCC toolchain to generate clang-compatible compile_commands.json
          # while still producing GCC-format coverage data (needed for fastcov)
          export CXX="clang++ --gcc-toolchain=/usr"
          export CC="clang --gcc-toolchain=/usr"
          ./scripts/z3/build.sh --static --coverage
      
      - name: Get commit hash
        id: get-commit
        working-directory: z3
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "Z3 commit hash: $COMMIT_HASH"
      
      - name: Measure binary size
        working-directory: z3
        run: |
          if [ -f "./build/z3" ]; then
            BINARY_SIZE=$(du -h ./build/z3 | cut -f1)
            BINARY_SIZE_BYTES=$(stat -f%z ./build/z3 2>/dev/null || stat -c%s ./build/z3 2>/dev/null)
            echo "Binary size: $BINARY_SIZE ($BINARY_SIZE_BYTES bytes)"
            echo "binary_size=$BINARY_SIZE" >> $GITHUB_OUTPUT
            echo "binary_size_bytes=$BINARY_SIZE_BYTES" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Binary not found at ./build/z3"
            exit 1
          fi
      
      - name: Collect build artifacts (headers, binary, compile_commands)
        run: |
          ./scripts/z3/collect_build_artifacts.sh z3/build .artifacts
      
      - name: Compress collected artifacts
        run: |
          cd .artifacts
          tar -czf ../z3/build/artifacts.tar.gz .
          cd ..
          COMPRESSED_SIZE=$(du -h z3/build/artifacts.tar.gz | cut -f1)
          echo "Compressed size: $COMPRESSED_SIZE"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Upload coverage binary to S3
        run: |
          aws s3api put-object \
            --bucket ${{ secrets.AWS_S3_BUCKET }} \
            --key solvers/z3/builds/coverage/${{ steps.get-commit.outputs.commit_hash }}.tar.gz \
            --body z3/build/artifacts.tar.gz \
            --tagging "Type=Coverage"
          echo "âœ… Uploaded coverage binary to S3"
      
      - name: Update last built SHA artifact
        if: needs.check-upstream.outputs.is_manual_build != 'true'
        run: |
          mkdir -p .cache
          echo "${{ steps.get-commit.outputs.commit_hash }}" > .cache/z3_last_sha
      
      - name: Upload last built SHA artifact
        if: needs.check-upstream.outputs.is_manual_build != 'true'
        uses: actions/upload-artifact@v4
        with:
          name: z3-last-sha
          path: .cache/z3_last_sha
          retention-days: 30
          overwrite: true

  skip-build:
    needs: check-upstream
    if: needs.check-upstream.outputs.build_needed == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Skip build (up to date)
        run: echo "âœ… Z3 is up to date - skipping build"
