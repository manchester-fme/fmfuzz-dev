name: Build Z3

on:
  workflow_dispatch:
    inputs:
      z3_commit_hash:
        description: 'Optional: Z3 commit hash to add to build queue'
        required: false
        type: string
  schedule:
    - cron: '5,35 * * * *'  # Run every 30 minutes starting at 00:05 (00:05, 00:35, 01:05, 01:35, etc.)

jobs:
  check-build-queue:
    runs-on: ubuntu-latest
    outputs:
      build_needed: ${{ steps.set-outputs.outputs.build_needed }}
      sha: ${{ steps.set-outputs.outputs.sha }}
      is_manual_build: ${{ steps.set-outputs.outputs.is_manual_build }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: pip install boto3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Check build queue or add manual commit
        id: set-outputs
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
        run: |
          if [ -n "${{ inputs.z3_commit_hash }}" ]; then
            COMMIT_HASH="${{ inputs.z3_commit_hash }}"
            echo "üî® Adding provided commit to build queue: $COMMIT_HASH"
            python scripts/scheduling/s3_state.py z3 build-queue add "$COMMIT_HASH"
            echo "build_needed=true" >> $GITHUB_OUTPUT
            echo "sha=$COMMIT_HASH" >> $GITHUB_OUTPUT
            echo "is_manual_build=true" >> $GITHUB_OUTPUT
          else
            COMMIT_HASH=$(python scripts/scheduling/builder.py z3)
            if [ -n "$COMMIT_HASH" ]; then
              echo "build_needed=true" >> $GITHUB_OUTPUT
              echo "sha=$COMMIT_HASH" >> $GITHUB_OUTPUT
              echo "is_manual_build=false" >> $GITHUB_OUTPUT
            else
              echo "build_needed=false" >> $GITHUB_OUTPUT
              echo "sha=" >> $GITHUB_OUTPUT
              echo "is_manual_build=false" >> $GITHUB_OUTPUT
            fi
          fi

  build-static:
    needs: check-build-queue
    if: needs.check-build-queue.outputs.build_needed == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Prepare Z3 for commit
        run: |
          COMMIT_HASH="${{ needs.check-build-queue.outputs.sha }}"
          echo "üî® Building commit: $COMMIT_HASH"
          if [ -d "z3" ]; then
            rm -rf z3
          fi
          git clone https://github.com/Z3Prover/z3.git z3
          cd z3
          git checkout $COMMIT_HASH
          echo "Checked out commit: $(git rev-parse HEAD)"
          cd ..
      
      - name: Build Z3 static binary
        run: ./scripts/z3/build.sh --static
      
      - name: Get commit hash
        id: get-commit
        working-directory: z3
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "Z3 commit hash: $COMMIT_HASH"
      
      - name: Measure binary size
        working-directory: z3
        run: |
          if [ -f "./build/z3" ]; then
            BINARY_SIZE=$(du -h ./build/z3 | cut -f1)
            BINARY_SIZE_BYTES=$(stat -f%z ./build/z3 2>/dev/null || stat -c%s ./build/z3 2>/dev/null)
            echo "Binary size: $BINARY_SIZE ($BINARY_SIZE_BYTES bytes)"
            echo "binary_size=$BINARY_SIZE" >> $GITHUB_OUTPUT
            echo "binary_size_bytes=$BINARY_SIZE_BYTES" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Binary not found at ./build/z3"
            exit 1
          fi
      
      - name: Collect build artifacts (headers, binary, compile_commands)
        run: |
          ./scripts/z3/collect_build_artifacts.sh z3/build .artifacts
      
      - name: Compress collected artifacts
        run: |
          cd .artifacts
          tar -czf ../z3/build/artifacts.tar.gz .
          cd ..
          COMPRESSED_SIZE=$(du -h z3/build/artifacts.tar.gz | cut -f1)
          echo "Compressed size: $COMPRESSED_SIZE"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Check if commit is still in build queue
        id: check-queue
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
        run: |
          COMMIT_HASH="${{ steps.get-commit.outputs.commit_hash }}"
          IN_QUEUE=$(python scripts/scheduling/s3_state.py z3 build-queue check "$COMMIT_HASH" 2>&1 | tail -1)
          if [ "$IN_QUEUE" = "true" ]; then
            echo "‚úÖ Commit $COMMIT_HASH is still in build queue, will upload"
            echo "should_upload=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Commit $COMMIT_HASH was removed from queue, discarding build"
            echo "should_upload=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload production binary to S3
        if: steps.check-queue.outputs.should_upload == 'true'
        run: |
          aws s3api put-object \
            --bucket ${{ secrets.AWS_S3_BUCKET }} \
            --key solvers/z3/builds/production/${{ steps.get-commit.outputs.commit_hash }}.tar.gz \
            --body z3/build/artifacts.tar.gz \
            --tagging "Type=Production"
          echo "‚úÖ Uploaded production binary to S3"
      
      - name: Discard build (not in queue)
        if: steps.check-queue.outputs.should_upload == 'false'
        run: |
          echo "‚ö†Ô∏è  Build discarded - commit was removed from queue"

  build-static-coverage:
    needs: check-build-queue
    if: needs.check-build-queue.outputs.build_needed == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Install LLVM/Clang 17
        uses: KyleMayes/install-llvm-action@v2
        with:
          version: '17'
      
      - name: Add LLVM to PATH
        run: echo "${{ env.LLVM_PATH }}/bin" >> $GITHUB_PATH
      
      - name: Clean any previous build
        run: |
          if [ -d "z3/build" ]; then
            rm -rf z3/build
            echo "Cleaned previous build directory"
          fi
      
      - name: Prepare Z3 for commit
        run: |
          COMMIT_HASH="${{ needs.check-build-queue.outputs.sha }}"
          echo "üî® Building commit: $COMMIT_HASH"
          if [ -d "z3" ]; then
            rm -rf z3
          fi
          git clone https://github.com/Z3Prover/z3.git z3
          cd z3
          git checkout $COMMIT_HASH
          echo "Checked out commit: $(git rev-parse HEAD)"
          cd ..
      
      - name: Build Z3 static binary with coverage
        run: |
          # Use clang with GCC toolchain to generate clang-compatible compile_commands.json
          # while still producing GCC-format coverage data (needed for fastcov)
          export CXX="clang++ --gcc-toolchain=/usr"
          export CC="clang --gcc-toolchain=/usr"
          ./scripts/z3/build.sh --static --coverage
      
      - name: Get commit hash
        id: get-commit
        working-directory: z3
        run: |
          COMMIT_HASH=$(git rev-parse HEAD)
          echo "commit_hash=$COMMIT_HASH" >> $GITHUB_OUTPUT
          echo "Z3 commit hash: $COMMIT_HASH"
      
      - name: Measure binary size
        working-directory: z3
        run: |
          if [ -f "./build/z3" ]; then
            BINARY_SIZE=$(du -h ./build/z3 | cut -f1)
            BINARY_SIZE_BYTES=$(stat -f%z ./build/z3 2>/dev/null || stat -c%s ./build/z3 2>/dev/null)
            echo "Binary size: $BINARY_SIZE ($BINARY_SIZE_BYTES bytes)"
            echo "binary_size=$BINARY_SIZE" >> $GITHUB_OUTPUT
            echo "binary_size_bytes=$BINARY_SIZE_BYTES" >> $GITHUB_OUTPUT
          else
            echo "ERROR: Binary not found at ./build/z3"
            exit 1
          fi
      
      - name: Collect build artifacts (headers, binary, compile_commands)
        run: |
          ./scripts/z3/collect_build_artifacts.sh z3/build .artifacts
      
      - name: Compress collected artifacts
        run: |
          cd .artifacts
          tar -czf ../z3/build/artifacts.tar.gz .
          cd ..
          COMPRESSED_SIZE=$(du -h z3/build/artifacts.tar.gz | cut -f1)
          echo "Compressed size: $COMPRESSED_SIZE"
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Check if commit is still in build queue (coverage)
        id: check-queue-coverage
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
        run: |
          COMMIT_HASH="${{ steps.get-commit.outputs.commit_hash }}"
          IN_QUEUE=$(python scripts/scheduling/s3_state.py z3 build-queue check "$COMMIT_HASH" 2>&1 | tail -1)
          if [ "$IN_QUEUE" = "true" ]; then
            echo "‚úÖ Commit $COMMIT_HASH is still in build queue, will upload"
            echo "should_upload=true" >> $GITHUB_OUTPUT
          else
            echo "‚ö†Ô∏è  Commit $COMMIT_HASH was removed from queue, discarding build"
            echo "should_upload=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Upload coverage binary to S3
        if: steps.check-queue-coverage.outputs.should_upload == 'true'
        run: |
          aws s3api put-object \
            --bucket ${{ secrets.AWS_S3_BUCKET }} \
            --key solvers/z3/builds/coverage/${{ steps.get-commit.outputs.commit_hash }}.tar.gz \
            --body z3/build/artifacts.tar.gz \
            --tagging "Type=Coverage"
          echo "‚úÖ Uploaded coverage binary to S3"
      
      - name: Discard coverage build (not in queue)
        if: steps.check-queue-coverage.outputs.should_upload == 'false'
        run: |
          echo "‚ö†Ô∏è  Coverage build discarded - commit was removed from queue"

  mark-as-built:
    needs: [check-build-queue, build-static, build-static-coverage]
    if: needs.build-static.result == 'success' && needs.build-static-coverage.result == 'success'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: pip install boto3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Move commit to built state
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
        run: |
          COMMIT_HASH="${{ needs.check-build-queue.outputs.sha }}"
          # Verify commit is still in queue before marking as built
          IN_QUEUE=$(python scripts/scheduling/s3_state.py z3 build-queue check "$COMMIT_HASH" 2>&1 | tail -1)
          if [ "$IN_QUEUE" = "true" ]; then
            python scripts/scheduling/s3_state.py z3 build-queue move-to-built $COMMIT_HASH
            echo "‚úÖ Moved commit $COMMIT_HASH to built state (both binaries uploaded)"
          else
            echo "‚ö†Ô∏è  Commit $COMMIT_HASH was removed from queue, skipping mark-as-built"
          fi

  mark-as-failed:
    needs: [check-build-queue, build-static, build-static-coverage]
    if: |
      always() &&
      needs.check-build-queue.result == 'success' &&
      (needs.build-static.result == 'failure' || needs.build-static-coverage.result == 'failure')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v5
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
      
      - name: Install dependencies
        run: pip install boto3
      
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v5.1.0
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}
      
      - name: Move commit to failed state
        env:
          AWS_S3_BUCKET: ${{ secrets.AWS_S3_BUCKET }}
        run: |
          COMMIT_HASH="${{ needs.check-build-queue.outputs.sha }}"
          python scripts/scheduling/s3_state.py z3 build-queue move-to-failed $COMMIT_HASH
          echo "‚ùå Moved commit $COMMIT_HASH to failed state (one or both builds failed)"

  skip-build:
    needs: check-build-queue
    if: needs.check-build-queue.outputs.build_needed == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: Skip build (no commits in queue)
        run: echo "‚úÖ No commits in build queue - skipping build"
